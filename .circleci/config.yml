version: 2.1
executors:
  docker-oe:
    docker:
      - image: tprrt/debian-oe:latest
    resource_class: medium
commands:
  prepare:
    parameters:
      manifest:
        default: nodistro/branch/master.xml
        type: string
    steps:
      - run:
          name: Configure Git
          command: |
            git config --global user.email ${CIRCLE_GIT_EMAIL}
            git config --global user.name ${CIRCLE_GIT_NAME}
      # - setup_remote_docker:
      #     docker_layer_caching: true
      - run:
          name: Setup the build environment
          command: |
            echo 'export PATH="${PATH}:/home/devuser/.local/bin"' >> $BASH_ENV
            source $BASH_ENV
            mkdir dist
            cd dist
            repo init -u git@github.com:tprrt/manifests.git -b $CIRCLE_BRANCH -m <<parameters.manifest>>
            repo sync -j4
            repo manifest -r -o manifest.xml
      - store_artifacts:
          path: ./dist/manifest.xml
      - persist_to_workspace:
          root: .
          paths:
            - dist
            - .gitconfig
            - .ssh
  fetch:
    parameters:
      manifest:
        default: nodistro/branch/master.xml
        type: string
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - downloads-{{ .Branch }}-<<parameters.manifest>>
            - downloads-{{ .Branch }}-
            - downloads-
      - run:
          name: Fetch sources
          command: |
            cd dist
            source ./layers/oe-init-build-env
            bitbake --runall=fetch core-image-minimal
      - store_artifacts:
          path: ./dist/conf/local.conf
      - store_artifacts:
          path: ./dist/conf/bblayers.conf
      - save_cache:
          key: downloads-{{ .Branch }}-<<parameters.manifest>>
          paths:
            - dist/build/downloads
      - persist_to_workspace:
          root: .
          paths:
            - dist
            - .gitconfig
            - .ssh
  build:
    parameters:
      manifest:
        default: nodistro/branch/master.xml
        type: string
    steps:
      - attach_workspace:
          at: .
      - restore_cache:
          keys:
            - sstate-cache-{{ .Branch }}-<<parameters.manifest>>
            - sstate-cache-{{ .Branch }}-
            - sstate-cache-
      - run:
          name: Build the image
          command: |
            cd dist
            source ./layers/oe-init-build-env
            bitbake core-image-minimal
      - save_cache:
          key: sstate-cache-{{ .Branch }}-<<parameters.manifest>>
          paths:
            - dist/build/sstate-cache
      - store_artifacts:
          path: ./dist/tmp/deploy
jobs:
  master-prepare:
    executor: docker-oe
    steps:
      - prepare:
        manifest: nodistro/branch/master.xml
  dunfell-prepare:
    executor: docker-oe
    steps:
      - prepare:
        manifest: nodistro/branch/dunfell.xml
  master-fetch:
    executor: docker-oe
    steps:
      - fetch:
        manifest: nodistro/branch/master.xml
  dunfell-fetch:
    executor: docker-oe
    steps:
      - fetch:
        manifest: nodistro/branch/dunfell.xml
  master-build:
    executor: docker-oe
    steps:
      - fetch:
        manifest: nodistro/branch/master.xml
  dunfell-build:
    executor: docker-oe
    steps:
      - fetch:
        manifest: nodistro/branch/dunfell.xml
workflows:
  version: 2
  master-prepare-fetch-build:
    jobs:
      - master-prepare:
          filters:
            branches:
              ignore:
                - gh-pages
      - master-fetch:
          filters:
            branches:
              ignore:
                - gh-pages
          requires:
            - master-prepare
      - master-build:
          filters:
            branches:
              ignore:
                - gh-pages
          requires:
            - master-fetch
  dunfell-prepare-fetch-build:
    jobs:
      - dunfell-prepare:
          filters:
            branches:
              ignore:
                - gh-pages
      - dunfell-fetch:
          filters:
            branches:
              ignore:
                - gh-pages
          requires:
            - dunfell-prepare
      - dunfell-build:
          filters:
            branches:
              ignore:
                - gh-pages
          requires:
            - dunfell-fetch
